name: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®

# æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-comfyui-plugins:
    name: æ›´æ–° ComfyUI æ’ä»¶æ•°æ®
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: è¿è¡Œ ComfyUI æ’ä»¶åˆ†æå™¨
        run: |
          cd he-forge-magic-box
          python -c "
          import sys
          import comfyui_plugin_analyzer as analyzer_module

          analyzer = analyzer_module.ComfyUIPluginAnalyzer()

          print('=' * 100)
          print('ComfyUI æ’ä»¶åˆ†æå·¥å…·'.center(100))
          print('è‡ªåŠ¨æ„å»ºæ¨¡å¼'.center(100))
          print('=' * 100)
          print()

          print('ğŸš€ å¼€å§‹ä¸‹è½½æ•°æ®...\n')
          if not analyzer.download_data():
              print('âŒ æ•°æ®ä¸‹è½½å¤±è´¥ï¼Œç¨‹åºé€€å‡º')
              sys.exit(1)

          print('\nğŸ”„ åˆå¹¶æ•°æ®ä¸­...')
          merged_data = analyzer.merge_data()

          import os
          output_dir = 'comfyui_plugin_analyzer'
          os.makedirs(output_dir, exist_ok=True)

          print('\nğŸ“¦ å¯¼å‡ºJSONæ•°æ®...')
          json_file = f'{output_dir}/comfyui_plugins_data.json'
          analyzer.export_to_json(merged_data, json_file)

          print('\nğŸŒ å¯¼å‡ºHTMLæŠ¥å‘Š...')
          html_file = f'{output_dir}/comfyui_plugins_dashboard.html'
          analyzer.export_to_html(merged_data, html_file)

          print('\nâœ… æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆå®Œæˆ')
          print(f'ğŸ“ è¾“å‡ºç›®å½•: he-forge-magic-box/{output_dir}')
          "

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          output_dir="he-forge-magic-box/comfyui_plugin_analyzer"
          json_file="$output_dir/comfyui_plugins_data.json"
          html_file="$output_dir/comfyui_plugins_dashboard.html"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–æˆ–æ˜¯å¦ä¸ºæ–°æ–‡ä»¶
          files_changed=0

          # æ£€æŸ¥ JSON æ–‡ä»¶
          if [[ -f "$json_file" ]]; then
            if [[ -n "$(git diff "$json_file")" ]]; then
              git add "$json_file"
              files_changed=1
              echo "âœ… JSON æ–‡ä»¶æœ‰å˜åŒ–"
            else
              echo "â„¹ï¸  JSON æ–‡ä»¶æ— å˜åŒ–"
            fi
          else
            echo "âš ï¸  JSON æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ£€æŸ¥ HTML æ–‡ä»¶
          if [[ -f "$html_file" ]]; then
            if [[ -n "$(git diff "$html_file")" ]]; then
              git add "$html_file"
              files_changed=1
              echo "âœ… HTML æ–‡ä»¶æœ‰å˜åŒ–"
            else
              echo "â„¹ï¸  HTML æ–‡ä»¶æ— å˜åŒ–"
            fi
          else
            echo "âš ï¸  HTML æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶æœªè·Ÿè¸ª
          if git status --porcelain | grep -q "^?.*$json_file"; then
            git add "$json_file"
            files_changed=1
            echo "âœ… æ·»åŠ æ–°æ–‡ä»¶: $json_file"
          fi

          if git status --porcelain | grep -q "^?.*$html_file"; then
            git add "$html_file"
            files_changed=1
            echo "âœ… æ·»åŠ æ–°æ–‡ä»¶: $html_file"
          fi

          # æäº¤å¹¶æ¨é€
          if [[ $files_changed -eq 1 ]]; then
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®"
            git push
            echo "âœ… æ–‡ä»¶æœ‰æ›´æ–°ï¼Œå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
