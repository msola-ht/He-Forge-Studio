name: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®

# æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-comfyui-plugins:
    name: æ›´æ–° ComfyUI æ’ä»¶æ•°æ®
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: è¿è¡Œ ComfyUI æ’ä»¶åˆ†æå™¨
        run: |
          python he-forge-magic-box/comfyui_plugin_analyzer.py << 'EOF'
          import json
          import requests
          from datetime import datetime
          from typing import Dict, List, Optional
          import os

          # ä½œè€…ä¿¡æ¯å­—å…¸
          AUTHOR_INFO = {
              "brand_cn": "ä½•ä¸ºé€ ç‰©",
              "brand_en": "He Forge Studio",
              "project_cn": "ä½•ä¸ºé€ ç‰© - é­”ç›’",
              "project_en": "He Forge Magic Box",
              "slogan_cn": "æ¯ä¸ªæƒ³æ³•ï¼Œéƒ½å€¼å¾—è¢«åˆ›é€ ",
              "slogan_en": "From Concept to Reality, Instantly",
              "name": "HeGenAI",
              "title": "è€ä½•çš„AIGCç ”ç©¶å®¤",
              "blog": "https://blog.msola.com",
              "wechat_mp": "https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzYyNDI2Mzg3OA==#wechat_redirect",
              "github": "https://github.com/msola-ht",
              "wechat_id": "hlsaigc",
              "bilibili": "https://space.bilibili.com/1313066",
              "telegram": "https://t.me/hegenai"
          }

          class ComfyUIPluginAnalyzer:
              """ComfyUIæ’ä»¶åˆ†æå™¨"""

              def __init__(self):
                  self.stats_url = "https://raw.githubusercontent.com/Comfy-Org/ComfyUI-Manager/main/github-stats.json"
                  self.plugins_url = "https://raw.githubusercontent.com/Comfy-Org/ComfyUI-Manager/main/custom-node-list.json"
                  self.stats_data = {}
                  self.plugins_data = {}

              def download_data(self) -> bool:
                  """ä¸‹è½½JSONæ•°æ®"""
                  try:
                      # ä¸‹è½½ç»Ÿè®¡æ•°æ®
                      print("ğŸŒ ä¸‹è½½ç»Ÿè®¡æ•°æ®...")
                      response = requests.get(self.stats_url, timeout=30)
                      response.raise_for_status()
                      self.stats_data = response.json()
                      print("âœ… ç»Ÿè®¡æ•°æ®å·²ä¸‹è½½")

                      # ä¸‹è½½æ’ä»¶åˆ—è¡¨
                      print("ğŸŒ ä¸‹è½½æ’ä»¶åˆ—è¡¨...")
                      response = requests.get(self.plugins_url, timeout=30)
                      response.raise_for_status()
                      self.plugins_data = response.json()
                      print("âœ… æ’ä»¶åˆ—è¡¨å·²ä¸‹è½½")

                      return True

                  except requests.RequestException as e:
                      print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
                      return False
                  except json.JSONDecodeError as e:
                      print(f"âŒ JSONè§£æå¤±è´¥: {e}")
                      return False

              def calculate_days_since_update(self, last_update_str: str) -> int:
                  """è®¡ç®—è·ç¦»æœ€åæ›´æ–°çš„å¤©æ•°"""
                  try:
                      last_update = datetime.strptime(last_update_str, "%Y-%m-%d %H:%M:%S")
                      current_time = datetime.now()
                      delta = current_time - last_update
                      return delta.days
                  except:
                      return -1

              def get_status_info(self, days_since_update: int, stars: int) -> tuple:
                  """è·å–çŠ¶æ€ä¿¡æ¯ (emoji, çŠ¶æ€æ–‡æœ¬, é¢œè‰²ä»£ç )"""
                  if days_since_update == -1:
                      return ("â“", "æœªçŸ¥", "gray")
                  elif days_since_update <= 7:
                      return ("ğŸŸ¢", "æ´»è·ƒ", "green")
                  elif days_since_update <= 30:
                      return ("ğŸŸ¡", "æ­£å¸¸", "yellow")
                  elif days_since_update <= 180:
                      return ("ğŸŸ ", "è¾ƒæ—§", "orange")
                  else:
                      return ("ğŸ”´", "åœæ»", "red")

              def merge_data(self) -> List[Dict]:
                  """åˆå¹¶æ’ä»¶æ•°æ®å’Œç»Ÿè®¡æ•°æ®"""
                  merged_data = []

                  custom_nodes = self.plugins_data.get("custom_nodes", [])
                  print(f"\nğŸ“Š æ‰¾åˆ° {len(custom_nodes)} ä¸ªæ’ä»¶")
                  print(f"ğŸ“Š ç»Ÿè®¡æ•°æ®åŒ…å« {len(self.stats_data)} ä¸ªä»“åº“\n")

                  for plugin in custom_nodes:
                      reference = plugin.get("reference", "")
                      # åˆ›å»ºåˆå¹¶åçš„æ•°æ®
                      merged_plugin = plugin.copy()

                      # æŸ¥æ‰¾åŒ¹é…çš„ç»Ÿè®¡æ•°æ®
                      if reference in self.stats_data:
                          stat = self.stats_data[reference]
                          days_since = self.calculate_days_since_update(stat["last_update"])

                          merged_plugin["stats"] = {
                              "stars": stat["stars"],
                              "last_update": stat["last_update"],
                              "days_since_update": days_since,
                              "author_account_age_days": stat["author_account_age_days"],
                              "author_account_age_years": round(stat["author_account_age_days"] / 365, 1),
                              "status": self.get_status_info(days_since, stat["stars"])
                          }
                      else:
                          merged_plugin["stats"] = None

                      merged_data.append(merged_plugin)

                  return merged_data

              def export_to_json(self, merged_data: List[Dict], filename: str):
                  """å¯¼å‡ºä¸ºJSONæ ¼å¼"""
                  # å‡†å¤‡å¯¼å‡ºæ•°æ®
                  export_data = []

                  for plugin in merged_data:
                      plugin_export = {
                          'title': plugin.get('title', ''),
                          'author': plugin.get('author', ''),
                          'id': plugin.get('id', ''),
                          'reference': plugin.get('reference', ''),
                          'description': plugin.get('description', ''),
                          'install_type': plugin.get('install_type', ''),
                          'stats': None
                      }

                      stats = plugin.get("stats")
                      if stats:
                          plugin_export['stats'] = {
                              'stars': stats['stars'],
                              'last_update': stats['last_update'],
                              'days_since_update': stats['days_since_update'],
                              'author_account_age_days': stats['author_account_age_days'],
                              'author_account_age_years': stats['author_account_age_years'],
                              'status_emoji': stats['status'][0],
                              'status_text': stats['status'][1],
                              'status_color': stats['status'][2]
                          }

                      export_data.append(plugin_export)

                  # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                  total = len(merged_data)
                  with_stats = sum(1 for p in merged_data if p.get("stats"))
                  total_stars = sum((p.get("stats") or {}).get("stars", 0) for p in merged_data)

                  summary = {
                      'total_plugins': total,
                      'plugins_with_stats': with_stats,
                      'total_stars': total_stars,
                      'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                      'author': AUTHOR_INFO
                  }

                  output = {
                      'summary': summary,
                      'plugins': export_data
                  }

                  with open(filename, 'w', encoding='utf-8') as f:
                      json.dump(output, f, ensure_ascii=False, indent=2)

                  print(f"âœ… JSONæ•°æ®å·²å¯¼å‡ºåˆ°: {filename}")
                  print(f"ğŸ“Š åŒ…å« {total} ä¸ªæ’ä»¶ï¼Œ{with_stats} ä¸ªæœ‰ç»Ÿè®¡æ•°æ®")

              def export_to_html(self, merged_data: List[Dict], filename: str):
                  """å¯¼å‡ºä¸ºHTMLæ ¼å¼ (ä½¿ç”¨Tailwind CSS + åˆ†é¡µ)"""
                  import html as html_module
                  import json

                  # ç»Ÿè®¡æ•°æ®
                  total = len(merged_data)
                  total_stars = 0
                  status_count = {"green": 0, "yellow": 0, "orange": 0, "red": 0, "unknown": 0}

                  # å‡†å¤‡æ’ä»¶æ•°æ®
                  plugins_json = []
                  for plugin in merged_data:
                      stats = plugin.get("stats")
                      title = html_module.escape(str(plugin.get('title', 'Unknown')))
                      author = html_module.escape(str(plugin.get('author', 'Unknown')))
                      reference = html_module.escape(str(plugin.get('reference', '#')))
                      description = html_module.escape(str(plugin.get('description', ''))[:80])

                      plugin_data = {
                          'title': title,
                          'author': author,
                          'reference': reference,
                          'description': description,
                          'status': 'â“',
                          'status_text': 'æœªçŸ¥',
                          'status_class': 'status-unknown',
                          'stars': 0,
                          'days': 0,
                          'age': 0,
                          'has_stats': False
                      }

                      if stats:
                          emoji, status_text, _ = stats["status"]
                          stars = stats['stars']
                          days = stats['days_since_update']
                          age = stats['author_account_age_years']

                          status_class_map = {
                              'ğŸŸ¢': 'status-active',
                              'ğŸŸ¡': 'status-normal',
                              'ğŸŸ ': 'status-old',
                              'ğŸ”´': 'status-stale'
                          }

                          if emoji == "ğŸŸ¢":
                              status_count["green"] += 1
                          elif emoji == "ğŸŸ¡":
                              status_count["yellow"] += 1
                          elif emoji == "ğŸŸ ":
                              status_count["orange"] += 1
                          elif emoji == "ğŸ”´":
                              status_count["red"] += 1

                          total_stars += stats["stars"]

                          plugin_data.update({
                              'status': emoji,
                              'status_text': status_text,
                              'status_class': status_class_map.get(emoji, 'status-unknown'),
                              'stars': stars,
                              'days': days,
                              'age': age,
                              'has_stats': True
                          })
                      else:
                          status_count["unknown"] += 1

                      plugins_json.append(plugin_data)

                  with_stats = sum(1 for p in merged_data if p.get("stats"))
                  avg_stars = total_stars // with_stats if with_stats > 0 else 0
                  generated_time = datetime.now().strftime("%Y/%m/%d %H:%M:%S")

                  # å°†æ•°æ®è½¬ä¸ºJSON
                  plugins_data_json = json.dumps(plugins_json, ensure_ascii=False)

                  html_content = f"""<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ComfyUI æ’ä»¶ç»Ÿè®¡æŠ¥å‘Š</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <style>
                  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                  body {{ font-family: 'Inter', sans-serif; }}
                  .gradient-bg {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }}
                  .card-hover {{ transition: all 0.3s ease; }}
                  .card-hover:hover {{ transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }}
                  .status-badge {{ display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }}
                  .status-active {{ background-color: #d1fae5; color: #065f46; }}
                  .status-normal {{ background-color: #fef3c7; color: #92400e; }}
                  .status-old {{ background-color: #fed7aa; color: #9a3412; }}
                  .status-stale {{ background-color: #fecaca; color: #991b1b; }}
                  .status-unknown {{ background-color: #e5e7eb; color: #374151; }}
                  .loading {{ display: flex; align-items: center; justify-content: center; padding: 2rem; }}
                  .spinner {{ border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }}
                  @keyframes spin {{ 0% {{ transform: rotate(0deg); }} 100% {{ transform: rotate(360deg); }} }}
              </style>
          </head>
          <body class="bg-gray-50">
              <div class="gradient-bg text-white py-12 px-4 sm:px-6 lg:px-8">
                  <div class="max-w-7xl mx-auto">
                      <h1 class="text-4xl font-bold text-center mb-2">ğŸ¨ ComfyUI æ’ä»¶ç»Ÿè®¡æŠ¥å‘Š</h1>
                      <p class="text-center text-white/80 text-lg">ç”Ÿæˆæ—¶é—´: {generated_time}</p>
                      <p class="text-center text-white/70 text-sm mt-2">
                          ä½œè€…: <a href="{AUTHOR_INFO['github']}" class="text-white hover:text-white/80 underline">{AUTHOR_INFO['name']}</a> ({AUTHOR_INFO['title']})
                      </p>
                  </div>
              </div>

              <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-gray-500 text-sm font-medium">æ€»æ’ä»¶æ•°</p>
                                  <p class="text-3xl font-bold text-gray-900 mt-2">{total}</p>
                              </div>
                              <div class="bg-blue-100 rounded-full p-3">
                                  <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                  </svg>
                              </div>
                          </div>
                          <div class="mt-4">
                              <span class="text-green-600 text-sm font-medium">âœ“ {with_stats} æœ‰æ•°æ®</span>
                              <span class="text-gray-400 text-sm ml-2">â€¢ {total - with_stats} æ— æ•°æ®</span>
                          </div>
                      </div>

                      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-gray-500 text-sm font-medium">æ€»æ˜Ÿæ ‡æ•°</p>
                                  <p class="text-3xl font-bold text-gray-900 mt-2">{total_stars:,}</p>
                              </div>
                              <div class="bg-yellow-100 rounded-full p-3">
                                  <svg class="w-8 h-8 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                  </svg>
                              </div>
                          </div>
                          <div class="mt-4">
                              <span class="text-gray-600 text-sm">å¹³å‡ {avg_stars} æ˜Ÿ/æ’ä»¶</span>
                          </div>
                      </div>

                      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-gray-500 text-sm font-medium">æ´»è·ƒæ’ä»¶</p>
                                  <p class="text-3xl font-bold text-green-600 mt-2">{status_count['green']}</p>
                              </div>
                              <div class="bg-green-100 rounded-full p-3">
                                  <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                  </svg>
                              </div>
                          </div>
                          <div class="mt-4">
                              <span class="text-green-600 text-sm font-medium">7å¤©å†…æ›´æ–°</span>
                          </div>
                      </div>

                      <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-gray-500 text-sm font-medium">åœæ»æ’ä»¶</p>
                                  <p class="text-3xl font-bold text-red-600 mt-2">{status_count['red']}</p>
                              </div>
                              <div class="bg-red-100 rounded-full p-3">
                                  <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                  </svg>
                              </div>
                          </div>
                          <div class="mt-4">
                              <span class="text-red-600 text-sm font-medium">180å¤©ä»¥ä¸Šæœªæ›´æ–°</span>
                          </div>
                      </div>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“Š æ´»è·ƒåº¦åˆ†å¸ƒ</h3>
                          <canvas id="statusChart"></canvas>
                      </div>

                      <div class="bg-white rounded-xl shadow-lg p-6">
                          <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ¯ çŠ¶æ€è¯´æ˜</h3>
                          <div class="space-y-3">
                              <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                  <div class="flex items-center">
                                      <span class="text-2xl mr-3">ğŸŸ¢</span>
                                      <div><p class="font-medium text-gray-900">æ´»è·ƒ</p><p class="text-sm text-gray-600">7å¤©å†…æ›´æ–°</p></div>
                                  </div>
                                  <span class="text-2xl font-bold text-green-600">{status_count['green']}</span>
                              </div>
                              <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                  <div class="flex items-center">
                                      <span class="text-2xl mr-3">ğŸŸ¡</span>
                                      <div><p class="font-medium text-gray-900">æ­£å¸¸</p><p class="text-sm text-gray-600">30å¤©å†…æ›´æ–°</p></div>
                                  </div>
                                  <span class="text-2xl font-bold text-yellow-600">{status_count['yellow']}</span>
                              </div>
                              <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                                  <div class="flex items-center">
                                      <span class="text-2xl mr-3">ğŸŸ </span>
                                      <div><p class="font-medium text-gray-900">è¾ƒæ—§</p><p class="text-sm text-gray-600">180å¤©å†…æ›´æ–°</p></div>
                                  </div>
                                  <span class="text-2xl font-bold text-orange-600">{status_count['orange']}</span>
                              </div>
                              <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                  <div class="flex items-center">
                                      <span class="text-2xl mr-3">ğŸ”´</span>
                                      <div><p class="font-medium text-gray-900">åœæ»</p><p class="text-sm text-gray-600">180å¤©ä»¥ä¸Šæœªæ›´æ–°</p></div>
                                  </div>
                                  <span class="text-2xl font-bold text-red-600">{status_count['red']}</span>
                              </div>
                          </div>
                      </div>
                  </div>

                  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                      <div class="flex flex-col md:flex-row gap-4">
                          <div class="flex-1">
                              <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” æœç´¢æ’ä»¶</label>
                              <input type="text" id="searchInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition" placeholder="è¾“å…¥æ’ä»¶åç§°ã€ä½œè€…æˆ–æè¿°...">
                          </div>
                          <div class="w-full md:w-48">
                              <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š æ’åºæ–¹å¼</label>
                              <select id="sortSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                                  <option value="stars">æ˜Ÿæ ‡æ•° â†“</option>
                                  <option value="update">æœ€è¿‘æ›´æ–° â†‘</option>
                                  <option value="name">åç§° A-Z</option>
                              </select>
                          </div>
                          <div class="w-full md:w-32">
                              <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“„ æ¯é¡µæ˜¾ç¤º</label>
                              <select id="pageSize" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                                  <option value="20">20æ¡</option>
                                  <option value="50">50æ¡</option>
                                  <option value="100">100æ¡</option>
                              </select>
                          </div>
                      </div>
                      <div class="mt-4 flex flex-wrap gap-2">
                          <button onclick="filterByStatus('all')" class="filter-btn px-4 py-2 rounded-lg font-medium transition bg-purple-600 text-white hover:bg-purple-700">å…¨éƒ¨ ({total})</button>
                          <button onclick="filterByStatus('ğŸŸ¢')" class="filter-btn px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-green-100">ğŸŸ¢ æ´»è·ƒ ({status_count['green']})</button>
                          <button onclick="filterByStatus('ğŸŸ¡')" class="filter-btn px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-yellow-100">ğŸŸ¡ æ­£å¸¸ ({status_count['yellow']})</button>
                          <button onclick="filterByStatus('ğŸŸ ')" class="filter-btn px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-orange-100">ğŸŸ  è¾ƒæ—§ ({status_count['orange']})</button>
                          <button onclick="filterByStatus('ğŸ”´')" class="filter-btn px-4 py-2 rounded-lg font-medium transition bg-gray-200 text-gray-700 hover:bg-red-100">ğŸ”´ åœæ» ({status_count['red']})</button>
                      </div>
                  </div>

                  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                      <div class="overflow-x-auto">
                          <table class="min-w-full divide-y divide-gray-200">
                              <thead class="bg-gray-50">
                                  <tr>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ’ä»¶åç§°</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½œè€…</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortData('stars')">â­ æ˜Ÿæ ‡</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortData('update')">ğŸ“… æ›´æ–°</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ğŸ‘¥ è´¦å·å¹´é¾„</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                  </tr>
                              </thead>
                              <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                          </table>
                      </div>
                      <div id="pagination" class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex items-center justify-between"></div>
                  </div>

                  <div class="mt-8 text-center text-gray-500 text-sm">
                      <p>Â© 2026 {AUTHOR_INFO['project_cn']} | {AUTHOR_INFO['brand_en']}</p>
                      <p class="mt-1">{AUTHOR_INFO['slogan_cn']}</p>
                      <p class="mt-2">æ•°æ®æ¥æº:<a href="https://github.com/Comfy-Org/ComfyUI-Manager" class="text-purple-600 hover:underline">ComfyUI-Manager</a></p>
                      <p class="mt-2">ä½œè€…: <a href="{AUTHOR_INFO['github']}" class="text-purple-600 hover:underline">{AUTHOR_INFO['name']}</a> ({AUTHOR_INFO['title']})</p>
                      <p class="mt-1">
                          <a href="{AUTHOR_INFO['blog']}" class="text-purple-600 hover:underline">BLOG</a> â€¢
                          <a href="{AUTHOR_INFO['wechat_mp']}" class="text-purple-600 hover:underline">å…¬ä¼—å·</a> â€¢
                          <a href="{AUTHOR_INFO['github']}" class="text-purple-600 hover:underline">GitHub</a> â€¢
                          <a href="{AUTHOR_INFO['bilibili']}" class="text-purple-600 hover:underline">Bç«™</a> â€¢
                          <a href="{AUTHOR_INFO['telegram']}" class="text-purple-600 hover:underline">Telegram</a>
                      </p>
                  </div>
              </div>

              <script>
                  const allData = {plugins_data_json};
                  let currentData = [...allData];
                  let currentPage = 1;
                  let pageSize = 20;
                  let currentSort = {{ field: null, dir: 'desc' }};
                  let currentFilter = 'all';
                  let searchQuery = '';

                  function init() {{
                      const ctx = document.getElementById('statusChart').getContext('2d');
                      new Chart(ctx, {{
                          type: 'doughnut',
                          data: {{
                              labels: ['ğŸŸ¢æ´»è·ƒ', 'ğŸŸ¡ æ­£å¸¸', 'ğŸŸ  è¾ƒæ—§', 'ğŸ”´ åœæ»', 'â“ æœªçŸ¥'],
                              datasets: [{{
                                  data: [{status_count['green']}, {status_count['yellow']}, {status_count['orange']}, {status_count['red']}, {status_count['unknown']}],
                                  backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(251, 191, 36, 0.8)', 'rgba(251, 146, 60, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(156, 163, 175, 0.8)'],
                                  borderWidth: 2,
                                  borderColor: '#fff'
                              }}]
                          }},
                          options: {{
                              responsive: true,
                              maintainAspectRatio: true,
                              plugins: {{ legend: {{ position: 'bottom', labels: {{ padding: 15, font: {{ size: 12 }} }} }} }}
                          }}
                      }});
                      renderTable();
                  }}

                  function filterData() {{
                      currentData = allData.filter(item => {{
                          const matchStatus = currentFilter === 'all' || item.status === currentFilter;
                          const matchSearch = !searchQuery ||
                              item.title.toLowerCase().includes(searchQuery) ||
                              item.author.toLowerCase().includes(searchQuery) ||
                              item.description.toLowerCase().includes(searchQuery);
                          return matchStatus && matchSearch;
                      }});
                      currentPage = 1;
                      if (currentSort.field) {{
                          sortDataInternal();
                      }}
                      renderTable();
                  }}

                  function filterByStatus(status) {{
                      currentFilter = status;
                      document.querySelectorAll('.filter-btn').forEach(btn => {{
                          btn.classList.remove('bg-purple-600', 'text-white');
                          btn.classList.add('bg-gray-200', 'text-gray-700');
                      }});
                      event.target.classList.remove('bg-gray-200', 'text-gray-700');
                      event.target.classList.add('bg-purple-600', 'text-white');
                      filterData();
                  }}

                  function sortData(field) {{
                      if (currentSort.field === field) {{
                          currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc';
                      }} else {{
                          currentSort.field = field;
                          currentSort.dir = field === 'stars' ? 'desc' : 'asc';
                      }}
                      sortDataInternal();
                      renderTable();
                  }}

                  function sortDataInternal() {{
                      const {{ field, dir }} = currentSort;
                      currentData.sort((a, b) => {{
                          let aVal, bVal;
                          if (field === 'stars') {{
                              aVal = a.has_stats ? a.stars : -1;
                              bVal = b.has_stats ? b.stars : -1;
                          }} else if (field === 'update') {{
                              aVal = a.has_stats ? a.days : 999999;
                              bVal = b.has_stats ? b.days : 999999;
                          }} else {{
                              return 0;
                          }}
                          if (dir === 'asc') return aVal - bVal;
                          return bVal - aVal;
                      }});
                  }}

                  function renderTable() {{
                      const tbody = document.getElementById('tableBody');
                      const start = (currentPage - 1) * pageSize;
                      const end = start + pageSize;
                      const pageData = currentData.slice(start, end);

                      if (pageData.length === 0) {{
                          tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ’ä»¶</td></tr>';
                          renderPagination(0);
                          return;
                      }}

                      tbody.innerHTML = pageData.map(item => `
                          <tr class="hover:bg-gray-50 transition">
                              <td class="px-6 py-4 whitespace-nowrap">
                                  <span class="status-badge ${{item.status_class}}">${{item.status}} ${{item.status_text}}</span>
                              </td>
                              <td class="px-6 py-4">
                                  <div class="text-sm font-medium text-gray-900">${{item.title}}</div>
                                  <div class="text-sm text-gray-500 truncate max-w-md">${{item.description}}...</div>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap">
                                  <div class="text-sm text-gray-900">${{item.author}}</div>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap">
                                  <div class="text-sm font-semibold ${{item.has_stats ? 'text-gray-900' : 'text-gray-400'}}">${{item.has_stats ? item.stars.toLocaleString() : 'N/A'}}</div>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap">
                                  <div class="text-sm ${{item.has_stats ? 'text-gray-900' : 'text-gray-400'}}">${{item.has_stats ? item.days + 'å¤©å‰' : 'N/A'}}</div>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap">
                                  <div class="text-sm ${{item.has_stats ? 'text-gray-900' : 'text-gray-400'}}">${{item.has_stats ? item.age + 'å¹´' : 'N/A'}}</div>
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm">
                                  <a href="${{item.reference}}" target="_blank" class="text-purple-600 hover:text-purple-900 font-medium">GitHub â†’</a>
                              </td>
                          </tr>
                      `).join('');

                      renderPagination(Math.ceil(currentData.length / pageSize));
                  }}

                  function renderPagination(totalPages) {{
                      const pagination = document.getElementById('pagination');
                      if (totalPages <= 1) {{
                          pagination.innerHTML = `<div class="text-sm text-gray-500">æ˜¾ç¤º ${{currentData.length}} æ¡ç»“æœ</div>`;
                          return;
                      }}

                      let html = `<div class="text-sm text-gray-500">æ˜¾ç¤º ${{(currentPage - 1) * pageSize + 1}}-${{Math.min(currentPage * pageSize, currentData.length)}} / ${{currentData.length}} æ¡</div>`;
                      html += `<div class="flex gap-2">`;

                      if (currentPage > 1) {{
                          html += `<button onclick="goToPage(${{currentPage - 1}})" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100">ä¸Šä¸€é¡µ</button>`;
                      }}

                      const startPage = Math.max(1, currentPage - 2);
                      const endPage = Math.min(totalPages, currentPage + 2);

                      if (startPage > 1) {{
                          html += `<button onclick="goToPage(1)" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100">1</button>`;
                          if (startPage > 2) html += `<span class="px-2">...</span>`;
                      }}

                      for (let i = startPage; i <= endPage; i++) {{
                          const active = i === currentPage ? 'bg-purple-600 text-white' : 'border border-gray-300 hover:bg-gray-100';
                          html += `<button onclick="goToPage(${{i}})" class="px-3 py-1 rounded ${{active}}">${{i}}</button>`;
                      }}

                      if (endPage < totalPages) {{
                          if (endPage < totalPages - 1) html += `<span class="px-2">...</span>`;
                          html += `<button onclick="goToPage(${{totalPages}})" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100">${{totalPages}}</button>`;
                      }}

                      if (currentPage < totalPages) {{
                          html += `<button onclick="goToPage(${{currentPage + 1}})" class="px-3 py-1 rounded border border-gray-300 hover:bg-gray-100">ä¸‹ä¸€é¡µ</button>`;
                      }}

                      html += `</div>`;
                      pagination.innerHTML = html;
                  }}

                  function goToPage(page) {{
                      currentPage = page;
                      renderTable();
                      window.scrollTo({{ top: 0, behavior: 'smooth' }});
                  }}

                  document.getElementById('searchInput').addEventListener('input', function(e) {{
                      searchQuery = e.target.value.toLowerCase();
                      filterData();
                  }});

                  document.getElementById('sortSelect').addEventListener('change', function(e) {{
                      const sortMap = {{ 'stars': 'stars', 'update': 'update', 'name': null }};
                      const field = sortMap[e.target.value];
                      if (field) {{
                          sortData(field);
                      }}
                  }});

                  document.getElementById('pageSize').addEventListener('change', function(e) {{
                      pageSize = parseInt(e.target.value);
                      currentPage = 1;
                      renderTable();
                  }});

                  init();
              </script>
          </body>
          </html>"""

                  with open(filename, 'w', encoding='utf-8') as f:
                      f.write(html_content)

                  print(f"âœ… HTMLæŠ¥å‘Šå·²å¯¼å‡ºåˆ°: {filename}")
                  print(f"ğŸ¨ ä½¿ç”¨åˆ†é¡µåŠ è½½ï¼Œæ€§èƒ½ä¼˜åŒ–å®Œæˆ")

          def main():
              """ä¸»ç¨‹åº"""
              print("=" * 100)
              print(f"{'ComfyUI æ’ä»¶åˆ†æå·¥å…·':^100}")
              print(f"{'è‡ªåŠ¨æ„å»ºæ¨¡å¼':^100}")
              print("=" * 100)
              print()

              analyzer = ComfyUIPluginAnalyzer()

              # ä¸‹è½½æ•°æ®
              print("ğŸš€ å¼€å§‹ä¸‹è½½æ•°æ®...\n")
              if not analyzer.download_data():
                  print("âŒ æ•°æ®ä¸‹è½½å¤±è´¥ï¼Œç¨‹åºé€€å‡º")
                  return

              # åˆå¹¶æ•°æ®
              print("\nğŸ”„ åˆå¹¶æ•°æ®ä¸­...")
              merged_data = analyzer.merge_data()

              # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
              output_dir = "he-forge-magic-box/comfyui_plugin_analyzer"
              os.makedirs(output_dir, exist_ok=True)

              # å¯¼å‡ºJSON
              print("\nğŸ“¦ å¯¼å‡ºJSONæ•°æ®...")
              json_file = f"{output_dir}/comfyui_plugins_data.json"
              analyzer.export_to_json(merged_data, json_file)

              # å¯¼å‡ºHTML
              print("\nğŸŒ å¯¼å‡ºHTMLæŠ¥å‘Š...")
              html_file = f"{output_dir}/comfyui_plugins_dashboard.html"
              analyzer.export_to_html(merged_data, html_file)

              print("\nâœ… æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆå®Œæˆ")
              print(f"ğŸ“ è¾“å‡ºç›®å½•: {output_dir}")

          if __name__ == "__main__":
              main()
          EOF

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          output_dir="he-forge-magic-box/comfyui_plugin_analyzer"
          json_file="$output_dir/comfyui_plugins_data.json"
          html_file="$output_dir/comfyui_plugins_dashboard.html"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–æˆ–æ˜¯å¦ä¸ºæ–°æ–‡ä»¶
          files_changed=0

          # æ£€æŸ¥ JSON æ–‡ä»¶
          if [[ -f "$json_file" ]]; then
            if [[ -n "$(git diff "$json_file")" ]]; then
              git add "$json_file"
              files_changed=1
              echo "âœ… JSON æ–‡ä»¶æœ‰å˜åŒ–"
            else
              echo "â„¹ï¸  JSON æ–‡ä»¶æ— å˜åŒ–"
            fi
          else
            echo "âš ï¸  JSON æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ£€æŸ¥ HTML æ–‡ä»¶
          if [[ -f "$html_file" ]]; then
            if [[ -n "$(git diff "$html_file")" ]]; then
              git add "$html_file"
              files_changed=1
              echo "âœ… HTML æ–‡ä»¶æœ‰å˜åŒ–"
            else
              echo "â„¹ï¸  HTML æ–‡ä»¶æ— å˜åŒ–"
            fi
          else
            echo "âš ï¸  HTML æ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶æœªè·Ÿè¸ª
          if git status --porcelain | grep -q "^?.*$json_file"; then
            git add "$json_file"
            files_changed=1
            echo "âœ… æ·»åŠ æ–°æ–‡ä»¶: $json_file"
          fi

          if git status --porcelain | grep -q "^?.*$html_file"; then
            git add "$html_file"
            files_changed=1
            echo "âœ… æ·»åŠ æ–°æ–‡ä»¶: $html_file"
          fi

          # æäº¤å¹¶æ¨é€
          if [[ $files_changed -eq 1 ]]; then
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®"
            git push
            echo "âœ… æ–‡ä»¶æœ‰æ›´æ–°ï¼Œå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
