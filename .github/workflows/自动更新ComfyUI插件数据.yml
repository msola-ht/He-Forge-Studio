name: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®

# æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-comfyui-plugins:
    name: æ›´æ–° ComfyUI æ’ä»¶æ•°æ®
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: ä¸‹è½½å¹¶åˆå¹¶ ComfyUI æ’ä»¶æ•°æ®
        run: |
          python << 'EOF'
          import json
          import requests

          def download_and_merge():
              """ä¸‹è½½å¹¶åˆå¹¶ComfyUIæ’ä»¶æ•°æ®"""
              # URLåœ°å€
              stats_url = "https://raw.githubusercontent.com/Comfy-Org/ComfyUI-Manager/main/github-stats.json"
              plugins_url = "https://raw.githubusercontent.com/Comfy-Org/ComfyUI-Manager/main/custom-node-list.json"

              print("ğŸŒ ä¸‹è½½æ•°æ®ä¸­...")

              try:
                  # ä¸‹è½½ç»Ÿè®¡æ•°æ®
                  print("  - ä¸‹è½½ github-stats.json")
                  stats_response = requests.get(stats_url, timeout=30)
                  stats_response.raise_for_status()
                  stats_data = stats_response.json()

                  # ä¸‹è½½æ’ä»¶åˆ—è¡¨
                  print("  - ä¸‹è½½ custom-node-list.json")
                  plugins_response = requests.get(plugins_url, timeout=30)
                  plugins_response.raise_for_status()
                  plugins_data = plugins_response.json()

                  print("âœ… ä¸‹è½½å®Œæˆ\n")

              except Exception as e:
                  print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
                  return

              # åˆå¹¶æ•°æ®
              print("ğŸ”„ åˆå¹¶æ•°æ®ä¸­...")

              merged_result = {
                  "custom_nodes": []
              }

              for plugin in plugins_data.get("custom_nodes", []):
                  # å¤åˆ¶æ’ä»¶ä¿¡æ¯
                  merged_plugin = plugin.copy()

                  # æŸ¥æ‰¾å¯¹åº”çš„ç»Ÿè®¡æ•°æ®
                  reference = plugin.get("reference", "")
                  if reference in stats_data:
                      merged_plugin["github_stats"] = stats_data[reference]
                  else:
                      merged_plugin["github_stats"] = None

                  merged_result["custom_nodes"].append(merged_plugin)

              print(f"âœ… åˆå¹¶å®Œæˆï¼Œå…± {len(merged_result['custom_nodes'])} ä¸ªæ’ä»¶\n")

              # ç¡®ä¿ç›®å½•å­˜åœ¨
              import os
              os.makedirs("he-forge-magic-box", exist_ok=True)

              # ä¿å­˜ä¸ºJSONæ–‡ä»¶
              output_file = "he-forge-magic-box/comfyui_plugins.json"
              with open(output_file, 'w', encoding='utf-8') as f:
                  json.dump(merged_result, f, ensure_ascii=False, indent=2)

              print(f"ğŸ’¾ å·²ä¿å­˜åˆ°: {output_file}")
              print(f"ğŸ“Š æ–‡ä»¶å¤§å°: {len(json.dumps(merged_result)) / 1024:.2f} KB")

          if __name__ == "__main__":
              download_and_merge()
          EOF

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if [[ -n "$(git diff he-forge-magic-box/comfyui_plugins.json)" ]]; then
            git add he-forge-magic-box/comfyui_plugins.json
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° ComfyUI æ’ä»¶æ•°æ®"
            git push
            echo "âœ… æ–‡ä»¶æœ‰æ›´æ–°ï¼Œå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
