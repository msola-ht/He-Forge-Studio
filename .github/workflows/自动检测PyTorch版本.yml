name: è‡ªåŠ¨æ£€æµ‹ PyTorch ç‰ˆæœ¬

# æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  check-versions:
    name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4

      - name: è·å– PyTorch ç‰ˆæœ¬ä¿¡æ¯
        run: |
          python << 'EOF'
          #!/usr/bin/env python3
          """
          PyTorch ä»“åº“ç‰ˆæœ¬ä¿¡æ¯è·å–è„šæœ¬

          @author HeGenAI
          @since 2026-01-15

          æ­¤è„šæœ¬ä» PyTorch å®˜æ–¹ä»“åº“è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆ JSON æ–‡ä»¶
          """

          import requests
          from bs4 import BeautifulSoup
          import re
          import json
          import time
          from concurrent.futures import ThreadPoolExecutor
          import urllib3
          from pathlib import Path
          from datetime import datetime

          # ç¦ç”¨å®‰å…¨è¯·æ±‚è­¦å‘Š
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # [è€ä½•çš„AIGCç ”ç©¶å®¤] é…ç½®ä¿¡æ¯
          BASE_URL = "http://download.pytorch.org/whl/"
          CU_DIR_PATTERN = re.compile(r'^cu(\d+)/')
          TORCH_WHL_PATTERN = re.compile(r'torch-([\d\.]+)')
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }

          # é…ç½®æ–‡ä»¶è·¯å¾„
          CONFIG_DIR = Path("he-forge-magic-box")
          CONFIG_FILE = CONFIG_DIR / "pytorch_versions.json"


          def robust_get(url, retries=3, timeout=30):
              """å¸¦é‡è¯•ä¸”æ”¯æŒ HTTP çš„è¯·æ±‚å‡½æ•°"""
              for i in range(retries):
                  try:
                      resp = requests.get(url, headers=HEADERS, timeout=timeout, verify=False, allow_redirects=True)
                      resp.raise_for_status()
                      return resp
                  except Exception:
                      if i == retries - 1:
                          return None
                      time.sleep(2)
              return None


          def is_torch_ge_26(v_str):
              """åˆ¤æ–­ PyTorch ç‰ˆæœ¬æ˜¯å¦ >= 2.6"""
              try:
                  parts = [int(p) for p in v_str.split('.') if p.isdigit()]
                  if not parts:
                      return False
                  if parts[0] > 2:
                      return True
                  if parts[0] == 2 and len(parts) >= 2 and parts[1] >= 6:
                      return True
                  return False
              except:
                  return False


          def get_filtered_versions(cuda_dir):
              """æŠ“å– CUDA ç›®å½•ï¼Œè¿”å›ç»Ÿä¸€çš„ HTTP ç´¢å¼•åœ°å€"""
              check_paths = [f"{cuda_dir}torch/", cuda_dir]
              version_map = {}

              cu_code = cuda_dir.strip('/').replace('cu', '')
              formatted_cu = f"{cu_code[:-1]}.{cu_code[-1]}"
              canonical_url = f"http://download.pytorch.org/whl/{cuda_dir}"

              for path in check_paths:
                  full_url = f"{BASE_URL}{path}"
                  resp = robust_get(full_url)
                  if not resp:
                      continue

                  soup = BeautifulSoup(resp.text, 'html.parser')
                  for a in soup.find_all('a'):
                      m = TORCH_WHL_PATTERN.search(a.get('href', ''))
                      if m:
                          v = m.group(1)
                          if is_torch_ge_26(v):
                              if v not in version_map:
                                  version_map[v] = {
                                      "tag": f"{v}+{formatted_cu}",
                                      "torch": v,
                                      "cuda": formatted_cu,
                                      "index_url": canonical_url
                                  }
              return list(version_map.values())


          def main():
              print("=" * 60)
              print("PyTorch ä»“åº“ç‰ˆæœ¬ä¿¡æ¯è·å–è„šæœ¬")
              print("=" * 60)

              # è·å–ä¸»é¡µ
              resp = robust_get(BASE_URL)
              if not resp:
                  print("âŒ è¿æ¥å¤±è´¥")
                  return

              soup = BeautifulSoup(resp.text, 'html.parser')
              links = [a.get('href') for a in soup.find_all('a')]

              # è¿‡æ»¤ï¼š>= 126 ä¸” != 129
              target_dirs = []
              for l in links:
                  match = CU_DIR_PATTERN.match(l)
                  if match:
                      cu_val = int(match.group(1))
                      if cu_val >= 126 and cu_val != 129:
                          target_dirs.append(l)

              print(f"ğŸ“¦ æ‰¾åˆ° {len(target_dirs)} ä¸ª CUDA ç›®å½•")

              final_list = []
              with ThreadPoolExecutor(max_workers=3) as executor:
                  futures = [executor.submit(get_filtered_versions, d) for d in target_dirs]
                  for f in futures:
                      res = f.result()
                      if res:
                          final_list.extend(res)

              # æ’åºï¼šCUDA é™åºï¼ŒTorch é™åº
              final_list.sort(key=lambda x: (float(x['cuda']), [int(p) for p in x['torch'].split('.')]), reverse=True)

              # ç”Ÿæˆè¾“å‡ºæ•°æ®
              output = {
                  "updated_at": datetime.now().isoformat(),
                  "total_versions": len(final_list),
                  "versions": final_list
              }

              # ç¡®ä¿é…ç½®ç›®å½•å­˜åœ¨
              CONFIG_DIR.mkdir(parents=True, exist_ok=True)

              # å†™å…¥ JSON æ–‡ä»¶
              with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
                  json.dump(output, f, ensure_ascii=False, indent=2)

              print(f"âœ… æˆåŠŸè·å– {len(final_list)} ä¸ª PyTorch ç‰ˆæœ¬")
              print(f"ğŸ“„ æ–‡ä»¶å·²ä¿å­˜åˆ°: {CONFIG_FILE}")
              print("=" * 60)


          if __name__ == "__main__":
              main()
          EOF

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add he-forge-magic-box/pytorch_versions.json
          git diff --staged --quiet || git commit -m "chore: è‡ªåŠ¨æ›´æ–° PyTorch ç‰ˆæœ¬ä¿¡æ¯"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
