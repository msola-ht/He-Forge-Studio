name: è‡ªåŠ¨æ£€æµ‹ PyTorch ç‰ˆæœ¬

# æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œ
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  check-versions:
    name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: è·å– PyTorch Docker ç‰ˆæœ¬ä¿¡æ¯
        run: |
          python << 'EOF'
          #!/usr/bin/env python3
          """
          PyTorch å…¨å¹³å°ç‰ˆæœ¬å…¨è‡ªåŠ¨åŒ–é‡‡é›†å·¥å…·

          @author HeGenAI
          @since 2026-01-15
          @org è€ä½•çš„AIGCç ”ç©¶å®¤

          åŠŸèƒ½ï¼š
          1. è¿œç¨‹æŠ“å– Docker Hub å®˜æ–¹ PyTorch Runtime é•œåƒæ ‡ç­¾ã€‚
          2. è‡ªåŠ¨è®¡ç®— TorchVision å’Œ TorchAudio åŒ¹é…ç‰ˆæœ¬ã€‚
          3. è‡ªåŠ¨ç”Ÿæˆ Windows/Linux(CUDA)ã€Mac(OSX)ã€CPUã€AMD(ROCM) çš„ pip å®‰è£…æŒ‡ä»¤ã€‚
          """

          import requests
          import re
          import json
          from datetime import datetime
          from pathlib import Path

          # [è€ä½•çš„AIGCç ”ç©¶å®¤] é…ç½®ä¿¡æ¯
          DOCKER_API_URL = "https://hub.docker.com/v2/repositories/pytorch/pytorch/tags/"
          # ä¸¥æ ¼åŒ¹é… runtime æ ¼å¼: 2.9.1-cuda12.8-cudnn9-runtime
          TAG_PATTERN = re.compile(r'^(\d+\.\d+\.\d+)-cuda(\d+\.\d+)-cudnn\d+-runtime')
          WHL_URL = "https://download.pytorch.org/whl"

          CONFIG_DIR = Path("he-forge-magic-box")
          CONFIG_FILE = CONFIG_DIR / "pytorch_docker_versions.json"

          def get_expected_versions(torch_v):
              """æ ¹æ® PyTorch å®˜æ–¹å‘å¸ƒè§„å¾‹è®¡ç®—é…å¥—ç‰ˆæœ¬ (N=M+15)"""
              try:
                  parts = [int(p) for p in torch_v.split('.')]
                  major, minor, patch = parts[0], parts[1], parts[2]
                  # TorchVision ç‰ˆæœ¬è§„å¾‹: 0.(minor+15).patch
                  # TorchAudio ç‰ˆæœ¬è§„å¾‹: major.minor.patch
                  return f"0.{minor + 15}.{patch}", f"{major}.{minor}.{patch}"
              except:
                  return "unknown", "unknown"

          def generate_pip_commands(t, v, a, cu):
              """ç”Ÿæˆå…¨å¹³å°å®‰è£…æŒ‡ä»¤"""
              base_pkg = f"torch=={t} torchvision=={v} torchaudio=={a}"
              cu_flat = cu.replace('.', '')  # 12.6 -> 126

              return {
                  "windows_linux_cuda": f"pip install {base_pkg} --index-url {WHL_URL}/cu{cu_flat}",
                  "linux_rocm": f"pip install {base_pkg} --index-url {WHL_URL}/rocm6.4",
                  "cpu_only": f"pip install {base_pkg} --index-url {WHL_URL}/cpu",
                  "osx_mac": f"pip install {base_pkg}"
              }

          def fetch_all_tags():
              """éå† Docker Hub API è·å–æ ‡ç­¾"""
              print("ğŸ” æ­£åœ¨ä» Docker Hub æŠ“å– PyTorch Runtime é•œåƒæ ‡ç­¾...")
              tags = []
              url = f"{DOCKER_API_URL}?page_size=100&ordering=last_updated"

              max_pages = 5
              current_page = 1

              while url and current_page <= max_pages:
                  try:
                      resp = requests.get(url, timeout=15)
                      data = resp.json()
                      results = data.get('results', [])
                      for item in results:
                          tags.append(item['name'])
                      url = data.get('next')
                      current_page += 1
                      print(f"  - å·²è·å–ç¬¬ {current_page-1} é¡µï¼Œå½“å‰æ€»è®¡ {len(tags)} ä¸ªæ ‡ç­¾")
                  except Exception as e:
                      print(f"âŒ ç½‘ç»œè¯·æ±‚å¼‚å¸¸: {e}")
                      break
              print(f"âœ… æ ‡ç­¾æŠ“å–å®Œæˆï¼Œå…±æ£€ç´¢åˆ° {len(tags)} ä¸ªå€™é€‰æ ‡ç­¾ã€‚")
              return tags

          def parse_tags(tag_list):
              """è§£æå¹¶æ„å»ºå®Œæ•´çš„æ•°æ®ç»“æ„"""
              print("âš™ï¸ æ­£åœ¨è§£æç‰ˆæœ¬é€»è¾‘å¹¶ç”Ÿæˆå…¨å¹³å°æŒ‡ä»¤...")
              version_map = {}

              for tag in tag_list:
                  match = TAG_PATTERN.match(tag)
                  if match:
                      torch_v = match.group(1)
                      cuda_v = match.group(2)

                      # åŸºç¡€è¿‡æ»¤é€»è¾‘
                      t_parts = [int(p) for p in torch_v.split('.')]
                      if t_parts[0] == 2 and t_parts[1] < 6:
                          continue  # åªè¦ 2.6+

                      cu_val = float(cuda_v)
                      if cu_val < 12.6 or cu_val == 12.9:
                          continue  # åªè¦ 12.6+, æ’é™¤ 12.9

                      key = f"{torch_v}-{cuda_v}"
                      if key not in version_map:
                          exp_v, exp_a = get_expected_versions(torch_v)

                          # ç”ŸæˆæŒ‡ä»¤
                          commands = generate_pip_commands(torch_v, exp_v, exp_a, cuda_v)

                          version_map[key] = {
                              "tag": f"{torch_v}+cu{cuda_v}",
                              "torch": torch_v,
                              "torchvision": exp_v,
                              "torchaudio": exp_a,
                              "cuda": cuda_v,
                              "docker_image": f"pytorch/pytorch:{tag}",
                              "install_commands": commands
                          }

              # æ’åºï¼šæŒ‰ CUDA ç‰ˆæœ¬é™åºï¼Œå†æŒ‰ Torch ç‰ˆæœ¬é™åº
              final_list = list(version_map.values())
              final_list.sort(key=lambda x: (float(x['cuda']), [int(p) for p in x['torch'].split('.')]), reverse=True)
              return final_list

          def main():
              print("=" * 70)
              print("ğŸš€ è€ä½•çš„AIGCç ”ç©¶å®¤ - PyTorch å…¨å¹³å°è‡ªåŠ¨åŒ–æ„å»ºåŠ©æ‰‹")
              print(f"ğŸ“… å½“å‰æ—¶é—´: {datetime.now().strftime('%Y/%m/%d %H:%M:%S')}")
              print("=" * 70)

              tags = fetch_all_tags()
              if not tags:
                  print("âŒ æœªèƒ½è·å–åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚")
                  return

              parsed_data = parse_tags(tags)

              output = {
                  "updated_at": datetime.now().isoformat(),
                  "author": "HeGenAI (è€ä½•çš„AIGCç ”ç©¶å®¤)",
                  "source": "Docker Hub (pytorch/pytorch)",
                  "total_combinations": len(parsed_data),
                  "versions": parsed_data
              }

              # ç¡®ä¿ç›®å½•å­˜åœ¨
              CONFIG_DIR.mkdir(parents=True, exist_ok=True)
              with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
                  json.dump(output, f, ensure_ascii=False, indent=2)

              print("-" * 70)
              print(f"ğŸ‰ æˆåŠŸï¼å·²è¯†åˆ« {len(parsed_data)} ç»„ PyTorch Runtime é»„é‡‘é…æ¯”ã€‚")
              print(f"ğŸ“„ æ•°æ®å·²å­˜è‡³: {CONFIG_FILE}")
              print("ğŸ’¡ æç¤º: æ¯ç»„ç‰ˆæœ¬å‡å·²åŒ…å« Windows/Linux/Mac/CPU çš„ pip å®‰è£…å‘½ä»¤ã€‚")
              print("=" * 70)

          if __name__ == "__main__":
              main()
          EOF

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if [[ -n "$(git diff he-forge-magic-box/pytorch_docker_versions.json)" ]]; then
            git add he-forge-magic-box/pytorch_docker_versions.json
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° PyTorch ç‰ˆæœ¬ä¿¡æ¯"
            git push
            echo "âœ… æ–‡ä»¶æœ‰æ›´æ–°ï¼Œå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
